<?phpinclude_once dirname(__FILE__) . '/../AdminGenericController.php';class Home extends AdminGenericController {    function __construct() {        parent::__construct(true, array("judge"));    }    function index() {        $schedule = new Schedule();        $judgemodel = new Judge();        $judgemodel->where("user_id", $this->session->userdata("id"));        $judge = $judgemodel->get();        $schedule->where("judge_id = " . $judge->id);        $schedule->select("project_id");        $data["evalprojects"] = $schedule->get();        $evaled = new Evaluation();        $evaled->where("judge_id = " . $judge->id);        $evaled->select("project_id");        $data['evaled'] = $evaled->get();        $judgeCategory = $judge->category->get();        $model = new Project();        $model->query("select p.* from project as p,category as c where p.category_id = c.id and c.group_id = " . $judgeCategory->group_id);        $data["projects"] = $model;        $data['main_content'] = 'frontend/judge/home_view';        $this->load->view('frontend/includes/template', $data);    }    function projects() {        $aColumns = array("id", "name", "team_leader_name", "school", "adult_sponsor_name");        $searchBy = array();        $model = new Project();        $orderCal = "id";        return $this->prepareTable($aColumns, $searchBy, $model, $orderCal);    }    function evalresults() {        $evaled = new Evaluation();        $judgemodel = new Judge();        $judgemodel->where("user_id", $this->session->userdata("id"));        $judge = $judgemodel->get();//        $schedule->where("judge_id = " . $judge->id . " and eval_total > 0");        if ($evaled->count() > 0) {            $evaled->where("judge_id = " . $judge->id . " and eval_total > 0");            $data['evals'] = $evaled->get();        }        $data['judge'] = $judge;        $data['main_content'] = 'frontend/judge/eval_result';        $this->load->view('frontend/includes/template', $data);    }    function showproject() {        $projectid = $this->uri->segment(4);        $model = new Project();        $model->get_by_id($projectid);        if (!$model->id) {            show_404();            die;        }        $category = $model->category->get();        $judgemodel = new Judge();        $judgemodel->where("user_id", $this->session->userdata("id"));        $judge = $judgemodel->get();        $judgeCategory = $judge->category->get();        if ($judgeCategory->group_id != $category->group_id) {            show_404();            die;        }        $data["project"] = $model;        $data['main_content'] = 'frontend/judge/project_view';        $this->load->view('frontend/includes/template', $data);    }    function evaluateproject() {        $projectid = $this->uri->segment(4);        $model = new Project();        $model->get_by_id($projectid);        if (!$model->id) {            show_404();            die;        }        $judgemodel = new Judge();        $judgemodel->where("user_id", $this->session->userdata("id"));        $judge = $judgemodel->get();        $schedModel = new Schedule();        $schedModel->where("project_id = " . $projectid . " and judge_id = " . $judge->id);        $schedule = $schedModel->get();        if (!$schedule->id) {            show_404();            die;        }        $data["project"] = $model;        $data['main_content'] = 'frontend/judge/project_evaluate';        $this->load->view('frontend/includes/template', $data);    }    function evaluation() {        $projectId = $this->input->post("projectId");        $judgemodel = new Judge();        $judgemodel->where("user_id", $this->session->userdata("id"));        $judge = $judgemodel->get();        $eval = new Evaluation();        $eval->project_id = $projectId;        $eval->judge_id = $judge->id;        $eval->eval_q_1 = $this->input->post("eval_q_1");        $eval->eval_q_2 = $this->input->post("eval_q_2");        $eval->eval_q_3 = $this->input->post("eval_q_3");        $eval->eval_q_4 = $this->input->post("eval_q_4");        $eval->eval_q_5 = $this->input->post("eval_q_5");        $eval->eval_q_6 = $this->input->post("eval_q_6");        $eval->eval_total = $this->input->post("eval_total");        $eval->save();        /* $schedModel = new Schedule();          $schedModel->where("project_id = " . $projectId . " and judge_id = " . $judge->id)->          update(array("eval_q_1" => $this->input->post("eval_q_1"),          "eval_q_2" => $this->input->post("eval_q_2"),          "eval_q_3" => $this->input->post("eval_q_3"),          "eval_q_4" => $this->input->post("eval_q_4"),          "eval_q_5" => $this->input->post("eval_q_5"),          "eval_q_6" => $this->input->post("eval_q_6"),          "eval_total" => $this->input->post("eval_total")          )); */        redirect(base_url() . "judge/home");    }    function schedule() {        $judgemodel = new Judge();        $judgemodel->where("user_id", $this->session->userdata("id"));        $judge = $judgemodel->get();        $schedModel = new Schedule();        $schedModel->where("judge_id = " . $judge->id);        $data["schedule"] = $schedModel->get();        $data['main_content'] = 'frontend/judge/judge_schedule';        $this->load->view('frontend/includes/template', $data);    }    function scorechart() {        $config = new Configuration();        $conf = $config->get_by_id(1);        if ($conf->announce_results == 1) {            $judgemodel = new Judge();            $judgemodel->where("user_id", $this->session->userdata("id"));            $judge = $judgemodel->get();            $judge->category->get();            $judge->category->group->get();            $group_id = $judge->category->group->id;            $schedule = new Evaluation();            $innerQuery = "select p.id from project as p,category as c where p.category_id = c.id and c.group_id = " . $group_id;            $data['schedules'] = $schedule->query("select s.* from project_evaluation as s where s.project_id in (" . $innerQuery . ")");            $data['group'] = $judge->category->group;        } else {            $data['error'] = 'Not Allowed';        }        $data['main_content'] = 'frontend/judge/group_score_chart';        $this->load->view('frontend/includes/template', $data);    }    function scoretable() {        $config = new Configuration();        $conf = $config->get_by_id(1);        if ($conf->announce_results == 1) {            $judgemodel = new Judge();            $judgemodel->where("user_id", $this->session->userdata("id"));            $judge = $judgemodel->get();            $judge->category->get();            $judge->category->group->get();            $group_id = $judge->category->group->id;            $data['group'] = $judge->category->group;            $query = "select p.code,p.name, avg(pe.eval_total) as score             from project as p,project_evaluation as pe,category as c where p.id = pe.project_id             and c.id = p.category_id and c.group_id=" . $group_id . " group by p.code order by score DESC";            $projectEvaluation = new ProjectEvaluation();            $data['results'] = $projectEvaluation->query($query);        } else {            $data['error'] = 'Not Allowed';        }        $data['main_content'] = 'frontend/judge/group_results';        $this->load->view('frontend/includes/template', $data);    }    protected function formatData($modelsResult) {        $data = array();        foreach ($modelsResult as $item) {            $item_data = array();            $item_data[] = $item->name;            $item_data[] = $item->team_leader_name;            $item_data[] = $item->school;            $item_data[] = $item->adult_sponsor_name;            $item_data[] = date('Y-m-d ', strtotime($item->start_date));            $item_data[] = date('Y-m-d ', strtotime($item->end_date));            $item_data[] = $item->id;            $item_data[] = $item->id;            $data[] = $item_data;        }        return $data;    }}?>