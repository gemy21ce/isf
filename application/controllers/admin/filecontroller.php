<?phpinclude_once dirname(__FILE__). '/../AdminGenericController.php';class FileController extends AdminGenericController {    var $path;    var $path_real;    function __construct() {        parent::__construct();        $this->path = realpath(APPPATH . '../images');        $this->path_real = base_url() . 'images/';    }    function upload() {        $data['image'] = $this->_do_upload();        if ($this->input->post('product') != null)            $data['product'] = true;        else            $data['product'] = false;        $this->load->view('backend/files/images_view', $data);    }    function delete() {        $this->is_logged_in();        if ($this->uri->segment(5) != null) {            $this->deletefile($this->uri->segment(5));            echo 'file delete';        }    }    function _do_upload() {        $this->load->model('File');        $insert = new File();        $insert->name = 'waiting';        if ($this->input->post('content') != null) {            $insert->content_id = $this->input->post('content');        }        $insert->save();        $file_id = $insert->id;        $new_path = $this->path . '/' . $file_id . '/';        mkdir($new_path, 0705);        $config = array(            'allowed_types' => '*',            'upload_path' => $new_path        );              $this->load->library('upload', $config);        $this->upload->do_upload();        echo $this->upload->display_errors();        $image_data = $this->upload->data();        $insert->name = $image_data['file_name'];        $insert->path = 'images/' . $file_id . '/';        $insert->save();        //  $new_file_insert['file_id'] = $file_id;        $insert->fileindexname = 'new_file';        if (!strstr($insert->name, '.swf') && !strstr($insert->name, '.SWF')) {            $config = array(                 'image_library' => 'gd2',            'source_image' => $image_data['full_path'],                'create_thumb' => TRUE,                'maintain_ratio' => TRUE,                'thumb_marker' => "_small",                'width' => 150,                'height' => 100            );            $this->load->library('image_lib', $config);            $this->image_lib->resize();        }        return $insert;    }    function get_images() {        $files = scandir($this->path);        $files = array_diff($files, array('.', '..', 'thumbs'));        $images = array();        foreach ($files as $file)            $images[] = array(                'url' => $this->path_real . $file,                'thumb' => $this->path_real . 'thumbs/' . $file            );        return $images;    }    function deleteFile($id) {        $this->load->model('File');        $file = new File();        $file->where('id', $id);        $file->get();        $file->delete();        $this->deleteDir($this->path . '/' . $id);    }    function deleteDir($dir) {        $dhandle = opendir($dir);        if ($dhandle) {            while (false !== ($fname = readdir($dhandle))) {                if (is_dir("{$dir}/{$fname}")) {                    if (($fname != '.') && ($fname != '..')) {                        deleteDir("$dir/$fname");                    }                } else {                    unlink("{$dir}/{$fname}");                }            }            closedir($dhandle);        }        rmdir($dir);    }    protected function formatData($modelsResult) {            }}?>